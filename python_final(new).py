# -*- coding: utf-8 -*-
"""python_final(new).ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1VMdD_EMpMsAM1EpKige8OKi_YLfeako3
"""

!wget -O TaipeiSansTCBeta-Regular.ttf https://drive.google.com/uc?id=1eGAsTN1HBpJAkeVM57_C7ccp7hbgSz3_&export=download

import datetime
import csv
import textwrap
import matplotlib.pyplot as plt
import matplotlib
import os

# è¨­å®šå­—å‹ï¼ˆæ”¯æ´ä¸­æ–‡ï¼‰
matplotlib.font_manager.fontManager.addfont('TaipeiSansTCBeta-Regular.ttf')
matplotlib.rc('font', family='Taipei Sans TC Beta')

# é è¨­è‡ªå‹•å­˜æª”çš„æª”å
DEFAULT_CSV_FILE = "central_ledger.csv"


class Ledger:
    def __init__(self, initial_balance=0.0):
        self.initial_balance = float(initial_balance)
        self.transactions = []  # list of dicts

    def add_transaction(self, date_str, t_type, amount, category, note):
        # t_type: "æ”¶å…¥" or "æ”¯å‡º"
        try:
            amount = float(amount)
        except ValueError:
            raise ValueError("é‡‘é¡å¿…é ˆæ˜¯æ•¸å­—")
        if amount < 0:
            raise ValueError("é‡‘é¡è«‹å¡«æ­£æ•¸ï¼Œæ”¶å…¥æˆ–æ”¯å‡ºç”¨é¡å‹å€åˆ†")

        signed = amount if t_type == "æ”¶å…¥" else -amount

        tx = {
            "date": date_str,
            "type": t_type,
            "amount": amount,
            "signed_amount": signed,
            "category": category,
            "note": note,
        }
        self.transactions.append(tx)

    def iter_transactions(self, only_today=False):
        if not only_today:
            for tx in self.transactions:
                yield tx
            return
        today_str = datetime.date.today().isoformat()
        for tx in self.transactions:
            if tx["date"] == today_str:
                yield tx

    def total_income_expense(self):
        income = 0.0
        expense = 0.0
        for tx in self.transactions:
            if tx["signed_amount"] >= 0:
                income += tx["signed_amount"]
            else:
                expense += -tx["signed_amount"]
        return income, expense

    def balance(self):
        income, expense = self.total_income_expense()
        return self.initial_balance + income - expense

    def summary_by_category(self):
        result = {}
        for tx in self.transactions:
            cat = tx["category"]
            signed = tx["signed_amount"]
            if cat not in result:
                result[cat] = {"income": 0.0, "expense": 0.0}
            if signed >= 0:
                result[cat]["income"] += signed
            else:
                result[cat]["expense"] += -signed
        return result

    def export_csv(self, filename=DEFAULT_CSV_FILE):
        """
        åŒ¯å‡ºç‚º CSVï¼š
        ç¬¬ä¸€åˆ—æœƒå¯«ä¸€ç­† type = 'é¤˜é¡' çš„ meta rowï¼Œç”¨ä¾†è¨˜éŒ„ initial_balanceã€‚
        å¾Œé¢æ¯ä¸€åˆ—æ˜¯ä¸€èˆ¬äº¤æ˜“ã€‚
        """
        fieldnames = ["date", "type", "category", "amount", "signed_amount", "note"]
        with open(filename, "w", newline="", encoding="utf-8") as f:
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()
            # æœŸåˆé¤˜é¡çš„ meta row
            writer.writerow({
                "date": "INIT",
                "type": "æœŸåˆé¤˜é¡",
                "category": "",
                "amount": self.initial_balance,
                "signed_amount": self.initial_balance,
                "note": "",
            })
            # å¯«å…¥å„ç­†äº¤æ˜“
            for tx in self.transactions:
                writer.writerow({
                    "date": tx["date"],
                    "type": tx["type"],
                    "category": tx["category"],
                    "amount": tx["amount"],
                    "signed_amount": tx["signed_amount"],
                    "note": tx["note"],
                })
        return filename

    def load_csv(self, filename=DEFAULT_CSV_FILE):
        """
        å¾æ—¢æœ‰çš„ CSV æª”æ¡ˆè¼‰å…¥äº¤æ˜“ç´€éŒ„èˆ‡æœŸåˆé¤˜é¡ã€‚
        è‹¥æª”æ¡ˆä¸­æœ‰ type = 'æœŸåˆé¤˜é¡' çš„åˆ—ï¼Œæœƒç”¨å®ƒçš„ amount ç•¶ä½œ initial_balanceã€‚
        å…¶ä»–åˆ—æœƒè¢«è¦–ç‚ºä¸€èˆ¬äº¤æ˜“ã€‚
        """
        self.transactions = []
        self.initial_balance = 0.0

        with open(filename, "r", newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                if not row:
                    continue
                row_type = row.get("type", "")
                # æœŸåˆé¤˜é¡ meta row
                if row_type == "æœŸåˆé¤˜é¡":
                    try:
                        self.initial_balance = float(row.get("amount", 0) or 0)
                    except ValueError:
                        self.initial_balance = 0.0
                    continue

                date_str = row.get("date", "")
                if not date_str or date_str == "INIT":
                    continue

                # ä¸€èˆ¬äº¤æ˜“
                self.add_transaction(
                    date_str,
                    row.get("type", "æ”¯å‡º"),
                    row.get("amount", 0),
                    row.get("category", "å…¶ä»–"),
                    row.get("note", ""),
                )
                )
                # è¼¸å…¥å·¥å…·ã€é¡åˆ¥è¨­å®šã€æ–°å¢è¨˜å¸³æµç¨‹
def safe_input(prompt=""):
    try:
        return input(prompt)
    except EOFError:
        return ""


def wrap_print(text, width=60):
    print("\n".join(textwrap.wrap(str(text), width)))


# é¡åˆ¥åˆ—è¡¨
DEFAULT_CATEGORIES = [
    "é¤é£²",
    "äº¤é€š",
    "ç”Ÿæ´»ç”¨å“",
    "æˆ¿ç§Ÿ",
    "å­¸ç¿’",
    "å¨›æ¨‚",
    "ç¤¾äº¤",
    "æ‰“å·¥æ”¶å…¥",
    "çå­¸é‡‘",
    "å…¶ä»–",
]

# æ¯å€‹é¡åˆ¥å°æ‡‰çš„æé†’æ–‡å­—
CATEGORY_MESSAGES = {
    "é¤é£²": "å¾ˆæ£’ï¼æœ‰å¥½å¥½åƒé£¯ï¼Œèº«é«”æ‰æœ‰åŠ›æ°£è³ºéŒ¢ã€‚",
    "äº¤é€š": "è·¯ä¸Šå°å¿ƒå®‰å…¨ï¼Œè¨˜å¾—çœ‹ç´…ç¶ ç‡ˆã€‚",
    "ç”Ÿæ´»ç”¨å“": "è£œçµ¦æ—¥å¸¸ç”¨å“ï¼Œç”Ÿæ´»æœƒé †å¾ˆå¤šã€‚",
    "æˆ¿ç§Ÿ": "ç¹³å®Œæˆ¿ç§Ÿï¼Œå°±æœ‰åœ°æ–¹å¯ä»¥å®‰å¿ƒèººå¹³ã€‚",
    "å­¸ç¿’": "æŠ•è³‡è‡ªå·±ï¼Œæ˜¯æœ€åˆ’ç®—çš„èŠ±è²»ä¹‹ä¸€ã€‚",
    "å¨›æ¨‚": "é©ç•¶æ”¾é¬†ä¸€ä¸‹ä¹Ÿå¾ˆé‡è¦ï¼Œè¨˜å¾—ä¸è¦å¤ªè¶…éå°±å¥½ã€‚",
    "ç¤¾äº¤": "ç¤¾äº¤ç´€éŒ„ +1ï¼Œåœ¨ä¸–ç•Œä¸Šç•™ä¸‹ä¸€é»å­˜åœ¨æ„Ÿã€‚",
    "æ‰“å·¥æ”¶å…¥": "è¾›è‹¦äº†ï¼éŒ¢éŒ¢æ­£åœ¨å‘ä½ å¥”ä¾†ã€‚",
    "çå­¸é‡‘": "å¤ªå¼·äº†ï¼Œé€£éŒ¢éƒ½åœ¨ç¨±è®šä½ çš„åŠªåŠ›ã€‚",
    "å…¶ä»–": "å·²è¨˜éŒ„é€™ç­†æ”¶æ”¯ï¼Œæœªä¾†å›é ­çœ‹ä¹Ÿä¸æœƒä¸€é ­éœ§æ°´ã€‚",
}


def daily_expense_for_date(ledger: Ledger, date_str: str) -> float:
    """è¨ˆç®—æŸä¸€å¤©çš„ç¸½æ”¯å‡ºï¼ˆé‡‘é¡åŠ ç¸½ï¼Œåªæœ‰æ”¯å‡ºï¼‰"""
    total = 0.0
    for tx in ledger.transactions:
        if tx["date"] == date_str and tx["signed_amount"] < 0:
            total += -tx["signed_amount"]
    return total


def flow_add_transaction(ledger: Ledger):
    print("\nï¼ï¼ æ–°å¢ä¸€ç­†è¨˜å¸³ ï¼ï¼")

    def flow_add_transaction(ledger: Ledger):
    print("\nï¼ï¼ æ–°å¢ä¸€ç­†è¨˜å¸³ ï¼ï¼")

    # ä¸€å®šè¦YYYY-MM-DDæ‰èƒ½å¾€ä¸‹
    while True:
        today_str = datetime.date.today().isoformat()
        date_str = safe_input(
            f"æ—¥æœŸï¼ˆé è¨­ {today_str}ï¼Œç›´æ¥ Enter ä½¿ç”¨é è¨­ï¼‰ï¼š"
        ).strip()
        if not date_str:
            date_str = today_str

        # æª¢æŸ¥æ—¥æœŸæ ¼å¼
        try:
            datetime.date.fromisoformat(date_str)
            break
        except ValueError:
            wrap_print("æ—¥æœŸæ ¼å¼ä¸æ˜¯ YYYY-MM-DDï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚")

    # ä¸€å®šè¦é¸æ”¯å‡º / æ”¶å…¥
    while True:
        print("\né€™ç­†æ˜¯æ”¶å…¥é‚„æ˜¯æ”¯å‡ºï¼Ÿ")
        print("1. æ”¯å‡º")
        print("2. æ”¶å…¥")
        t_choice = safe_input("è¼¸å…¥ 1 æˆ– 2ï¼š").strip()

        if t_choice == "1":
            t_type = "æ”¯å‡º"
            break
        elif t_choice == "2":
            t_type = "æ”¶å…¥"
            break
        else:
            wrap_print("è¼¸å…¥éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ 1ï¼ˆæ”¯å‡ºï¼‰æˆ– 2ï¼ˆæ”¶å…¥ï¼‰ã€‚")

    # é‡‘é¡é©—è­‰ï¼šä¸€å®šè¦æ­£æ•¸
    while True:
        amount_str = safe_input("é‡‘é¡ï¼ˆæ­£æ•¸ï¼‰ï¼š").strip()
        try:
            amount = float(amount_str)
            if amount <= 0:
                print("é‡‘é¡è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ•¸å­—ã€‚")
                continue
            break
        except ValueError:
            print("é‡‘é¡æ ¼å¼æ€ªæ€ªçš„ï¼Œå†è©¦ä¸€æ¬¡ï¼ˆåªèƒ½è¼¸å…¥æ•¸å­—ï¼‰ã€‚")

    print("\né¸æ“‡ä¸€å€‹é¡åˆ¥ï¼š")
    for idx, cat in enumerate(DEFAULT_CATEGORIES, start=1):
        print(f"{idx}. {cat}")
    print(f"{len(DEFAULT_CATEGORIES)+1}. è‡ªè¨‚é¡åˆ¥ï¼ˆè‡ªè¡Œè¼¸å…¥æ–‡å­—ï¼‰")

    cat_choice = safe_input("è¼¸å…¥ç·¨è™Ÿï¼š").strip()
    category = ""
    if cat_choice.isdigit():
        c_idx = int(cat_choice)
        if 1 <= c_idx <= len(DEFAULT_CATEGORIES):
            category = DEFAULT_CATEGORIES[c_idx - 1]
        elif c_idx == len(DEFAULT_CATEGORIES) + 1:
            category = safe_input("è¼¸å…¥è‡ªè¨‚é¡åˆ¥åç¨±ï¼š").strip() or "å…¶ä»–"
        else:
            category = "å…¶ä»–"
    else:
        category = "å…¶ä»–"

    note = safe_input("å‚™è¨»ï¼ˆå¯ä»¥ç©ºç™½ï¼‰ï¼š").strip()

    try:
        ledger.add_transaction(date_str, t_type, amount, category, note)
        wrap_print("å·²æ–°å¢ä¸€ç­†è¨˜å¸³ã€‚")

        #  è‡ªå‹•å­˜æª”ï¼šæ¯æ–°å¢ä¸€ç­†è¨˜å¸³å°±ç›´æ¥åŒ¯å‡ºåˆ°é è¨­ CSV
        try:
            ledger.export_csv(DEFAULT_CSV_FILE)
        except Exception as e:
            wrap_print(f"è‡ªå‹•å­˜æª”å¤±æ•—ï¼ˆä¸å½±éŸ¿æœ¬æ¬¡è¨˜å¸³ï¼‰ï¼š{e}")

        # é¡åˆ¥æé†’
        msg = CATEGORY_MESSAGES.get(
            category, "å·²è¨˜éŒ„é€™ç­†æ”¶æ”¯ï¼ŒæŒçºŒè¨˜ä¸‹å»å°±æœƒè¶Šä¾†è¶Šæœ‰æ„Ÿã€‚"
        )
        print(msg)

        # æ—¥æ”¯å‡ºæé†’ï¼ˆåªçœ‹æ”¯å‡ºï¼‰
        daily_exp = daily_expense_for_date(ledger, date_str)
        if daily_exp < 500:
            wrap_print(
                f"ä»Šå¤©ï¼ˆ{date_str}ï¼‰ç›®å‰ç¸½æ”¯å‡º {daily_exp:.0f} å…ƒï¼Œå¾ˆæ£’ï¼å¯ä»¥å­˜éŒ¢äº†ã€‚"
            )
        elif daily_exp > 2000:
            wrap_print(
                f"ä»Šå¤©ï¼ˆ{date_str}ï¼‰ç›®å‰ç¸½æ”¯å‡º {daily_exp:.0f} å…ƒï¼Œè¦æ³¨æ„æ¶ˆè²»å›‰ï¼"
            )

        # ç•¶å‰é¤˜é¡æé†’
        current_balance = ledger.balance()
        if current_balance < 1000:
            wrap_print(
                f"è­¦å‘Šï¼šç›®å‰å‰©é¤˜é‡‘é¡åªå‰©ä¸‹ {current_balance:.0f} å…ƒï¼Œå†é€™æ¨£å¯èƒ½æœƒæ´»ä¸ä¸‹å»ï¼Œè¨˜å¾—æ”¶æ–‚ä¸€ä¸‹é–‹æ”¯ã€‚"
            )

    except ValueError as e:
        wrap_print(f"æ–°å¢å¤±æ•—ï¼š{e}")


# æŸ¥çœ‹ç´€éŒ„ã€çµ±è¨ˆç¸½è¦½èˆ‡åœ“é¤…åœ–
def flow_show_records(ledger: Ledger):
    if not ledger.transactions:
        wrap_print("ç›®å‰é‚„æ²’æœ‰ä»»ä½•è¨˜å¸³ç´€éŒ„ã€‚å…ˆå»åŠ ä¸€ç­†çœ‹çœ‹ã€‚")
        return

    print("\nè¦çœ‹å“ªä¸€ç¨®ï¼Ÿ")
    print("1. åªçœ‹ä»Šå¤©")
    print("2. çœ‹å…¨éƒ¨")
    choice = safe_input("è¼¸å…¥ 1 æˆ– 2ï¼š").strip()
    only_today = (choice == "1")

    print("\nï¼ï¼ è¨˜å¸³ç´€éŒ„ ï¼ï¼")


    # å„²å­˜ç”¨æ–¼ç¹ªåœ–çš„è³‡æ–™
    expense_by_category = {}

    # å–å¾—äº¤æ˜“ç´€éŒ„
    for tx in ledger.iter_transactions(only_today=only_today):
        sign = "+" if tx["signed_amount"] >= 0 else "-"
        amt = abs(tx["signed_amount"])
        line = (
            f"{tx['date']}ï½œ{tx['type']}ï½œ{tx['category']}ï½œ"
            f"{sign}{amt}ï½œå‚™è¨»ï¼š{tx['note']}"
        )
        print(line)

        # åªçµ±è¨ˆæ”¯å‡ºï¼ˆè² æ•¸ï¼‰
        if tx["signed_amount"] < 0:
            cat = tx["category"]
            expense_by_category[cat] = expense_by_category.get(cat, 0.0) + amt

    print("\nï¼ï¼ å·²åˆ—å‡ºæ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„ ï¼ï¼\n")

    # è‹¥æ²’æœ‰ä»»ä½•æ”¯å‡ºç´€éŒ„
    if not expense_by_category:
        wrap_print("åœ¨é¸å®šçš„ç¯„åœå…§æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ”¯å‡ºç´€éŒ„ï¼Œç„¡æ³•ç”¢ç”Ÿçµ±è¨ˆåœ–è¡¨ã€‚")
        return

    # æº–å‚™ç¹ªåœ–è³‡æ–™
    categories = list(expense_by_category.keys())
    expenses = list(expense_by_category.values())

    # ä¸­æ–‡å­—é«”
    plt.rcParams["font.sans-serif"] = ["Arial Unicode MS"]

    # ç¹ªåœ–
    plt.figure(figsize=(8, 8))
    plt.pie(
        expenses,
        labels=categories,
        autopct="%1.1f%%",
        startangle=90,
        wedgeprops={"edgecolor": "black"},
    )
    plt.title(f"{'ä»Šå¤©' if only_today else 'æ‰€æœ‰'}æ”¯å‡ºé¡åˆ¥åˆ†ä½ˆåœ“é¤…åœ–")
    plt.axis("equal")

    # ğŸš€ éé˜»å¡é¡¯ç¤ºï¼Œä¸æœƒå¡ä½ä¸»é¸å–®
    plt.show(block=False)

    # å„²å­˜ç”¨æ–¼ç¹ªåœ–çš„è³‡æ–™
    expense_by_category = {}

    for tx in ledger.iter_transactions(only_today=only_today):
        sign = "+" if tx["signed_amount"] >= 0 else "-"
        amt = abs(tx["signed_amount"])
        line = (
            f"{tx['date']}ï½œ{tx['type']}ï½œ{tx['category']}ï½œ"
            f"{sign}{amt}ï½œå‚™è¨»ï¼š{tx['note']}"
        )
        print(line)
        # æ”¶é›†ç”¨æ–¼åœ“é¤…åœ–çš„æ”¯å‡ºæ•¸æ“š
        if tx["signed_amount"] < 0:  # åƒ…çµ±è¨ˆæ”¯å‡º
            cat = tx["category"]
            expense = amt  # å–æ­£æ•¸
            expense_by_category[cat] = expense_by_category.get(cat, 0.0) + expense
    print("ï¼ï¼ å·²åˆ—å‡ºæ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„ ï¼ï¼\n")

    # æª¢æŸ¥æ˜¯å¦æœ‰æ”¯å‡ºæ•¸æ“š
    if not expense_by_category:
        wrap_print("åœ¨é¸å®šçš„ç¯„åœå…§ï¼ˆä»Šå¤©/å…¨éƒ¨ï¼‰ï¼Œæ²’æœ‰æ‰¾åˆ°ä»»ä½•æ”¯å‡ºç´€éŒ„å¯ä¾›çµ±è¨ˆã€‚")
        return

    # æº–å‚™ç¹ªåœ–æ•¸æ“š
    categories = list(expense_by_category.keys())
    expenses = list(expense_by_category.values())

    # Colab ç’°å¢ƒä¸­éœ€è¦ä¸­æ–‡æ”¯æ´
    plt.rcParams["font.sans-serif"] = ["Arial Unicode MS"]
    # plt.rcParams['axes.unicode_minus'] = False

    # é–‹å§‹ç¹ªåœ–
    plt.figure(figsize=(8, 8))
    plt.pie(
        expenses,
        labels=categories,
        autopct="%1.1f%%",
        startangle=90,
        wedgeprops={"edgecolor": "black"},
    )
    plt.title(f"{'ä»Šå¤©' if only_today else 'æ‰€æœ‰'}æ”¯å‡ºé¡åˆ¥åˆ†ä½ˆåœ“é¤…åœ–")
    plt.axis("equal")  # ç¢ºä¿åœ“é¤…åœ–æ˜¯åœ“çš„
    plt.show()  # åœ¨ Colab ä¸­é¡¯ç¤ºåœ–è¡¨
    safe_input("\nåœ–è¡¨é¡¯ç¤ºå®Œç•¢ï¼ŒæŒ‰ Enter è¿”å›ä¸»é¸å–®...")



def flow_show_summary(ledger: Ledger):
    if not ledger.transactions:
        wrap_print("ç›®å‰é‚„æ²’æœ‰ä»»ä½•è¨˜å¸³ç´€éŒ„ï¼Œæ²’æœ‰æ±è¥¿å¯ä»¥çµ±è¨ˆã€‚")
        return

    income, expense = ledger.total_income_expense()
    balance = ledger.balance()

    print("\nï¼ï¼ çµ±è¨ˆç¸½è¦½ ï¼ï¼")
    print(f"ç¸½æ”¶å…¥ï¼š{income}")
    print(f"ç¸½æ”¯å‡ºï¼š{expense}")
    print(f"æœŸåˆé¤˜é¡ï¼š{ledger.initial_balance}")
    print(f"ç›®å‰é¤˜é¡ï¼š{balance}")

    print("\næŒ‰é¡åˆ¥çµ±è¨ˆï¼š")
    summary = ledger.summary_by_category()
    for cat, val in summary.items():
        print(f"- {cat}ï½œæ”¶å…¥ï¼š{val['income']}ï½œæ”¯å‡ºï¼š{val['expense']}")
    print("ï¼ï¼ çµ±è¨ˆçµæŸ ï¼ï¼\n")

    # é¤˜é¡å¤ªä½çš„æé†’
    if balance < 1000:
       wrap_print("æé†’ï¼šç›®å‰é¤˜é¡å·²ä½æ–¼ 1000 å…ƒï¼Œä¹‹å¾ŒèŠ±éŒ¢è¦æ›´å°å¿ƒä¸€é»ã€‚")

# åŒ¯å‡º CSVã€ä¸»ç¨‹å¼
def flow_export_csv(ledger: Ledger):
    if not ledger.transactions:
        wrap_print("æ²’æœ‰è³‡æ–™ï¼Œä¸éœ€è¦åŒ¯å‡ºã€‚")
        return
    filename = safe_input(
        f"è¼¸å…¥è¦åŒ¯å‡ºçš„æª”åï¼ˆé è¨­ {DEFAULT_CSV_FILE}ï¼‰ï¼š"
    ).strip()
    if not filename:
        filename = DEFAULT_CSV_FILE
    if not filename.endswith(".csv"):
        filename += ".csv"
    fname = ledger.export_csv(filename)
    wrap_print(
        f"å·²åŒ¯å‡ºåˆ°æª”æ¡ˆï¼š{fname}\nåœ¨ Colab å·¦é‚Šæª”æ¡ˆåˆ—è¡¨å¯ä»¥æ‰¾åˆ°ï¼Œç„¶å¾Œä¸‹è¼‰ã€‚"
    )


def main():
    wrap_print(
        "æ­¡è¿ä½¿ç”¨ã€Šè¨˜å¸³ç³»çµ±ã€‹ï¼š\n"
        "å°ˆå¿ƒæŠŠæ¯ä¸€ç­†æ”¶æ”¯è¨˜ä¸‹ä¾†ï¼Œé †ä¾¿å¹«ä½ çœ‹ä»Šå¤©èŠ±å¤šå°‘ã€é‚„èƒ½ä¸èƒ½æ´»ã€‚"
    )

    # æ˜¯å¦è¼‰å…¥ä¹‹å‰çš„ç´€éŒ„ï¼Ÿ
    use_old = False
    while True:
        ans = safe_input("æ˜¯å¦è¦å¾ä¹‹å‰å­˜å¥½çš„ CSV æª”æ¡ˆè¼‰å…¥ç´€éŒ„ï¼Ÿ(y/n)ï¼š").strip().lower()
        if ans in ("y", "n", ""):
            use_old = ans == "y"
            break
        wrap_print("è¼¸å…¥éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ y æˆ– nã€‚")

    ledger = None

    if use_old:
        filename = safe_input(
            f"è«‹è¼¸å…¥è¦è¼‰å…¥çš„æª”åï¼ˆç›´æ¥ Enter ä»£è¡¨ {DEFAULT_CSV_FILE}ï¼‰ï¼š"
        ).strip()
        if not filename:
            filename = DEFAULT_CSV_FILE

        if os.path.exists(filename):
            ledger = Ledger(initial_balance=0.0)
            try:
                ledger.load_csv(filename)
                last_balance = ledger.balance()
                wrap_print(
                    f"å·²å¾ {filename} è¼‰å…¥ä¹‹å‰çš„è¨˜å¸³ç´€éŒ„ã€‚"
                    f"\nä¸Šæ¬¡çµæŸæ™‚çš„é¤˜é¡ç´„ç‚º {last_balance:.0f} å…ƒï¼Œé€™æ¬¡æœƒå¾é€™å€‹é‡‘é¡ç¹¼çºŒè¨˜ã€‚"
                )
            except Exception as e:
                wrap_print(
                    f"è¼‰å…¥èˆŠè³‡æ–™å¤±æ•—ï¼š{e}\né€™æ¬¡æœƒæ”¹ç”¨ç©ºç™½å¸³æœ¬é‡æ–°é–‹å§‹ã€‚"
                )
                ledger = None
        else:
            wrap_print(
                f"æ‰¾ä¸åˆ°æª”æ¡ˆï¼š{filename}\nè«‹ç¢ºèªæª”æ¡ˆåœ¨åŒä¸€å€‹è³‡æ–™å¤¾æˆ– Colab å·¦å´å·²ä¸Šå‚³ã€‚"
                "\né€™æ¬¡æœƒæ”¹ç”¨ç©ºç™½å¸³æœ¬é‡æ–°é–‹å§‹ã€‚"
            )
            ledger = None

    # å¦‚æœæ²’æœ‰è¼‰å…¥èˆŠç´€éŒ„å°±å•é€™æ¬¡çš„æœŸåˆé¤˜é¡
    if ledger is None:
        init = safe_input("è«‹è¼¸å…¥é€™æ¬¡çš„æœŸåˆé¤˜é¡ï¼ˆå¯ä»¥ç›´æ¥ Enter ä»£è¡¨ 0ï¼‰ï¼š").strip()
        if not init:
            init = 0
        try:
            initial_balance = float(init)
        except ValueError:
            wrap_print("æœŸåˆé¤˜é¡è¼¸å…¥æ€ªæ€ªçš„ï¼Œç•¶ä½œ 0ã€‚")
            initial_balance = 0.0

        ledger = Ledger(initial_balance=initial_balance)

    # ä¸»é¸å–®
    while True:
        print("\nï¼ï¼ ä¸»é¸å–® ï¼ï¼")
        print("1. è¨˜ä¸€ç­†å¸³")
        print("2. æŸ¥çœ‹ç´€éŒ„")
        print("3. æŸ¥çœ‹çµ±è¨ˆ")
        print("4. åŒ¯å‡º CSV")
        print("5. é›¢é–‹")
        choice = safe_input("è«‹è¼¸å…¥é¸é …ç·¨è™Ÿï¼š").strip()

        if choice == "1":
            flow_add_transaction(ledger)
        elif choice == "2":
            flow_show_records(ledger)
        elif choice == "3":
            flow_show_summary(ledger)
        elif choice == "4":
            flow_export_csv(ledger)
        elif choice == "5":
            # æé†’ä¸‹è¼‰ CSV å‚™ä»½
            if ledger.transactions:
                wrap_print(
                    f"æé†’ï¼šé€™æ¬¡çš„è¨˜å¸³ç´€éŒ„å·²è‡ªå‹•å­˜æˆ {DEFAULT_CSV_FILE}ã€‚"
                    "\nå¦‚æœä½ æ˜¯åœ¨ Colabï¼Œè¨˜å¾—åˆ°å·¦é‚Šæª”æ¡ˆåˆ—è¡¨æŠŠé€™å€‹æª”æ¡ˆä¸‹è¼‰åˆ°è‡ªå·±é›»è…¦å‚™ä»½ã€‚"
                )
            wrap_print("æ„Ÿè¬ä½¿ç”¨ï¼Œç©©å®šè¨˜å¸³å°±æ˜¯æ…¢æ…¢æ‰“é€ å®‰å…¨æ„Ÿã€‚")
            break
        else:
            wrap_print("æŒ‰éŒ¯äº†ï¼Œè«‹é‡æ–°é¸ä¸€æ¬¡ã€‚")


if __name__ == "__main__":
    main()
